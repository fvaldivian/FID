---
title: "R Notebook"
output: html_notebook
---
```{r}
library(readr)
library(ggplot2)
library(dplyr)
library(corrplot)
library(corrplot)
library(caret)
```

Leyendo la base de datos y haciendo pequeño resumen para visualizar informacion relevante para analisis de estos datos.

```{r}
df <- read_csv('supermarket_db.csv', show_col_types = FALSE)
#head(df)
summary(df)
```

Buscando valores nulos en el dataset:
```{r}
missing_values <- colSums(is.na(df))
print(missing_values)
```
Analisis visual de las muestras dividida en genero (Male or Female)
```{r}
gender_counts <- table(df$Gender)
print(gender_counts)
ggplot(df, aes(x = Gender, fill = Gender)) +
  geom_bar() +
  geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) +
  scale_fill_manual(values = c("Male" = "blue", "Female" = "pink")) +
  labs(title = "Compradores por genero")
```
Practicamente no se encuentra diferencia alguna en cuanto a asistencia al mercado entre hombres y mujeres, siendo las mujeres las que mas asisten con un total de 501 muestras y hombres 499.

------------------------------------------------
La siguiente grafica mostrara las lineas de producto en las que los clientes tieneden a comprar más.
-> Clientes de género femenino:
```{r}
df_female <- df %>%
  filter(Gender == "Female")
ggplot(df_female, aes(x = `Product line`, y = Quantity, fill = Gender)) +
  geom_bar(stat = "identity") +
  labs(title = "Cantidad Comprada por Mujeres en Cada Línea de Producto", x = "Línea de Producto", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Male" = "blue", "Female" = "pink"))

```
Como resultado se aprecia que las mujeres que asisten a estos supermercados tiendene a compras mas productos de la linea "Fashion accessories".

-> Clienetes del género masculino.
```{r}
df_male <- filter(df, Gender == "Male")
ggplot(df_male, aes(x = `Product line`, y = Quantity, fill = Gender)) +
  geom_bar(stat = "identity") +
  labs(title = "Cantidad Comprada por Hombres en Cada Línea de Producto", x = "Línea de Producto", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Male" = "blue", "Female" = "pink")) 
```
Como resultado del analisis visual de compra segmentado por lineas de productos se llega a la conclusion que los hombres que asisten a nuestras tiendas tienden a realizar mas compras en "Health and beauty".

-----------------------------------------
Visualizacion de que ciudad tenia mas clientes tomados de muestra en la base de datos.

```{r}
place_df <- df %>%
  group_by(City) %>%
  summarise(CustomerCount = n())
print(place_df)
```

-------------------------------------------------------

Vizualizacion de los metodos de pago mas utilizados por los clientes.

```{r}
payment_df <- df %>%
  group_by(Payment) %>%
  summarise(Count = n())
print(payment_df)
```
```{r}
ggplot(payment_df, aes(x = Payment, y = Count, fill = Payment, label = Count)) +
  geom_bar(stat = "identity") +
  geom_text(position = position_stack(vjust = 0.5), size = 3) +
  labs(title = "Cantidad de Transacciones por Tipo de Pago", x = "Tipo de Pago", y = "Cantidad") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = c("Cash" = "blue", "Credit card" = "green", "Ewallet" = "orange"))

```
Visualizacion de lineas de producto que tienen mas ingresos brutos.

```{r}
ggplot(df, aes(x = `Product line`, y = `gross income`)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Ingreso Bruto por Línea de Producto", x = "Línea de Producto", y = "Ingreso Bruto") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

---------------------------------------------------

Visualizacion de la calificacion para cada liena de producto. 

```{r}
df %>%
  group_by(`Product line`) %>%
  summarise(Avg_Rating = mean(Rating, na.rm = TRUE)) %>%
  ggplot(aes(x = Avg_Rating, y = `Product line`)) +
  geom_col(fill = "blue") +
  labs(title = "Promedio de Calificación por Línea de Producto", x = "Promedio de Rating", y = "Product Line") +
  theme_minimal() +
  scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 1))

```

Utilizaremos el modelo de regresion lineal para predecir el total que se gastara un cliente en cada compra.
```{r}
data_total <- df[, c('Customer type', 'Quantity', 'Unit price', 'Total')]
set.seed(123)
indices_entrenamiento <- sample(1:nrow(data_total), 0.8 * nrow(data_total))
df_entrenamiento <- data_total[indices_entrenamiento, ]
df_prueba <- data_total[-indices_entrenamiento, ]
```
Entrenando el modelo
```{r}
modelo_regresion <- lm(Total ~ Quantity + `Unit price`, data = df_entrenamiento)
summary(modelo_regresion)
print(sqrt(0.8895))
```
La variable R cuadrado nos dice que tanto explica las variables dependientes las ventas

```{r}
predicciones <- predict(modelo_regresion, newdata = df_prueba)
df_prueba$Predicciones <- predicciones
```

```{r} 
plot(df_prueba$Total, col = "blue", pch = 16, xlab = "Índice", ylab = "Total", main = "Comparación entre Valores Reales y Predicciones")
points(df_prueba$Predicciones, col = "red", pch = 16)

abline(lm(Total ~ Predicciones, data = df_prueba), col = "green", lwd = 2)
legend("topright", legend = c("Real", "Predicción", "Regresión Lineal"), col = c("blue", "red", "green"), pch = 16)

```

```{r}
mse <- mean((df_prueba$Total - df_prueba$Predicciones)^2)
print(mse)

mae <- mean(abs(df_prueba$Total - df_prueba$Predicciones))
print(mae)

rsquared <- 1 - sum((df_prueba$Total - df_prueba$Predicciones)^2) / sum((df_prueba$Total - mean(df_prueba$Total))^2)
print(rsquared)
head(df_prueba)
```
Teniendo en cuenta los resultados podemos llegar a la concluciòn que aunque el R cuadrado sea bastante alto lo que indica que el modelo explica bien la variacion de los datos, el mse y mae son demasiado altos como para considerarse un buen modelo, teniendo en cuenta que las predicciones se desvian en promedio un 67.7 del Total real, por lo que el modelo puede no estar generalizando bien.

